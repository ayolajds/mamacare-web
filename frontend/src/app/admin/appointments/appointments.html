<!-- appointments.html -->
<div class="appointments-management">
  <!-- Header -->
  <div class="management-header">
    <div class="header-content">
      <div class="header-top">
        <button class="btn-volver" (click)="volverAtras()">
          <svg class="volver-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Volver Atrás
        </button>
      </div>
      <h1 class="management-title">Gestión de Sesiones</h1>
      <p class="management-subtitle">Administra citas ya programadas y asignadas</p>
    </div>
    <div class="header-actions">
      <button class="btn-refresh" (click)="loadAppointments()" [disabled]="isLoading">
        <svg class="refresh-icon" [class.loading]="isLoading" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        {{ isLoading ? 'Actualizando...' : 'Actualizar' }}
      </button>
    </div>
  </div>

  <!-- Filtros y Búsqueda -->
  <div class="filters-section">
    <div class="filters-main">
      <div class="search-box">
        <div class="search-input-wrapper">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input 
            type="text" 
            [(ngModel)]="searchTerm" 
            (input)="onSearch()"
            placeholder="Buscar por título, paciente o profesional..." 
            class="search-input"
          >
        </div>
      </div>

      <div class="filter-row">
        <select [(ngModel)]="statusFilter" (change)="onFilterChange()" class="filter-select">
          <option value="">Todos los estados</option>
          <option value="confirmed">Confirmada</option>
          <option value="completed">Completada</option>
          <option value="cancelled">Cancelada</option>
        </select>

        <input 
          type="date" 
          [(ngModel)]="dateFilter"
          (change)="onFilterChange()"
          class="filter-select"
        >

        <button (click)="clearFilters()" class="btn-clear-filters">
          <svg class="clear-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- Estados de carga y error -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="loading-spinner"></div>
    <p>Cargando sesiones...</p>
  </div>

  <div *ngIf="error && !isLoading" class="error-state">
    <div class="error-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </div>
    <h3>Error al cargar las sesiones</h3>
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="loadAppointments()">Reintentar</button>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!isLoading && !error" class="appointments-container">
    <!-- Resumen -->
    <div class="summary-bar">
      <span class="summary-text">
        Mostrando {{ filteredAppointments.length }} de {{ pagination.totalItems }} sesiones
        <span *ngIf="searchTerm || statusFilter || dateFilter" class="filtered-indicator">
          (filtradas)
        </span>
      </span>
    </div>

    <!-- Tarjetas de sesiones -->
    <div class="appointments-grid">
      <div *ngFor="let appointment of filteredAppointments" class="appointment-card">
        <div class="card-header">
          <h3 class="appointment-title">{{ appointment.title }}</h3>
          <div class="status-badge" [class]="getStatusBadgeClass(appointment.status)">
            {{ getStatusDisplay(appointment.status) }}
          </div>
        </div>

        <div class="card-content">
          <div class="info-row">
            <!-- ✅ NUEVO: Modalidad de la cita -->
            <div class="info-item">
              <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
              <div class="info-content">
                <span class="info-label">Modalidad</span>
                <span class="info-value">
                  <span [class]="'modalidad-badge ' + getModalidadBadgeClass(getModalidadDisplay(appointment))">
                    {{ getModalidadDisplay(appointment) }}
                  </span>
                </span>
                <span class="info-duration">{{ getUbicacionDisplay(appointment) }}</span>
              </div>
            </div>

            <div class="info-item">
              <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <div class="info-content">
                <span class="info-label">Fecha y Hora</span>
                <span class="info-value">{{ formatDateTime(appointment.date) }}</span>
                <span class="info-duration">{{ appointment.duration }} min</span>
              </div>
            </div>

            <div class="info-item">
              <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <div class="info-content">
                <span class="info-label">Paciente</span>
                <span class="info-value">
                  {{ getPatientName(appointment) }}
                </span>
                <span class="info-email">{{ getPatientEmail(appointment) }}</span>
              </div>
            </div>

            <div class="info-item">
              <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <div class="info-content">
                <span class="info-label">Profesional</span>
                <span class="info-value">
                  {{ getProfessionalName(appointment) }}
                </span>
                <span *ngIf="getProfessionalName(appointment) !== 'Profesional no asignado'" 
                      class="info-email">
                  {{ getProfessionalSpecialty(appointment) }}
                </span>
              </div>
            </div>

            <div *ngIf="appointment.paqueteId" class="info-item">
              <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
              </svg>
              <div class="info-content">
                <span class="info-label">Paquete</span>
                <span class="info-value">
                  {{ getPackageName(appointment.paqueteId) }}
                </span>
                <span class="info-duration">
                  {{ getPackageDuration(appointment.paqueteId) }}
                </span>
              </div>
            </div>
          </div>

          <!-- ✅ ACTUALIZADO: Usar getMotivoDisplay -->
          <div *ngIf="getMotivoDisplay(appointment) !== 'No especificado'" class="reason-section">
            <span class="reason-label">Motivo:</span>
            <p class="reason-text">{{ getMotivoDisplay(appointment) }}</p>
          </div>

          <!-- ✅ ACTUALIZADO: Usar getSymptoms -->
          <div *ngIf="hasSymptoms(appointment)" class="symptoms-section">
            <span class="symptoms-label">Síntomas reportados:</span>
            <div class="symptoms-tags">
              <span *ngFor="let sintoma of getSymptoms(appointment)" class="symptom-tag">
                {{ sintoma }}
              </span>
            </div>
          </div>
        </div>

        <div class="card-actions">
          <button 
            *ngIf="appointment.status !== 'cancelled' && appointment.status !== 'completed'"
            (click)="editAppointment(appointment)"
            class="btn-edit"
          >
            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Editar
          </button>

          <button 
            *ngIf="appointment.status === 'scheduled' || appointment.status === 'confirmed'"
            (click)="cancelAppointment(appointment)"
            [disabled]="isUpdating[appointment._id]"
            class="btn-cancel"
          >
            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            {{ isUpdating[appointment._id] ? 'Cancelando...' : 'Cancelar' }}
          </button>
        </div>
      </div>

      <!-- Estado vacío -->
      <div *ngIf="filteredAppointments.length === 0" class="empty-state">
        <div class="empty-content">
          <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <h3>No se encontraron sesiones</h3>
          <p *ngIf="searchTerm || statusFilter || dateFilter">
            Intenta ajustar los filtros de búsqueda
          </p>
          <p *ngIf="!searchTerm && !statusFilter && !dateFilter">
            No hay sesiones activas en el sistema. Las nuevas solicitudes aparecen en "Solicitudes Pendientes"
          </p>
          <button *ngIf="searchTerm || statusFilter || dateFilter" 
                  (click)="clearFilters()" 
                  class="btn-clear-filters">
            Limpiar filtros
          </button>
        </div>
      </div>
    </div>

    <!-- Paginación -->
    <div *ngIf="pagination.totalPages > 1" class="pagination-container">
      <div class="pagination-info">
        Página {{ pagination.currentPage }} de {{ pagination.totalPages }}
      </div>
      
      <div class="pagination-controls">
        <button 
          (click)="prevPage()" 
          [disabled]="!pagination.hasPrev"
          class="pagination-btn"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Anterior
        </button>

        <div class="page-numbers">
          <button 
            *ngFor="let page of getPageNumbers()" 
            (click)="goToPage(page)"
            [class.active]="page === pagination.currentPage"
            class="page-btn"
            [disabled]="isPageButtonDisabled(page)"
          >
            {{ getPageButtonText(page) }}
          </button>
        </div>

        <button 
          (click)="nextPage()" 
          [disabled]="!pagination.hasNext"
          class="pagination-btn"
        >
          Siguiente
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de edición de cita -->
<div *ngIf="showEditModal" class="modal-overlay" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Editar Cita</h2>
      <button class="modal-close" (click)="closeEditModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <form (ngSubmit)="updateAppointment()">
      <div class="modal-body">
        
        <!-- Información de solo lectura -->
        <div class="readonly-info" *ngIf="editingAppointment">
          <div class="info-item">
            <strong>Paciente:</strong> {{ getPatientName(editingAppointment) }}
          </div>
          <div class="info-item">
            <strong>Estado actual:</strong> {{ getStatusDisplay(editingAppointment.status) }}
          </div>
          <div class="info-item" *ngIf="editingAppointment.paqueteId">
            <strong>Paquete:</strong> {{ getPackageName(editingAppointment.paqueteId) }}
          </div>
          <div class="info-item">
            <strong>Modalidad:</strong> {{ getModalidadDisplay(editingAppointment) }}
          </div>
        </div>

        <!-- Profesional -->
        <div class="form-group">
          <label class="form-label">Profesional *</label>
          <select 
            [(ngModel)]="editAppointmentData.professionalId" 
            name="editProfessionalId" 
            class="form-select"
            required>
            <option value="">Seleccionar profesional</option>
            <option *ngFor="let user of professionals" [value]="user._id">
              {{ user.name }} {{ user.lastName }} 
              <span *ngIf="user.especialidad">- {{ user.especialidad }}</span>
            </option>
          </select>
        </div>

        <!-- Fecha y Hora -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Fecha *</label>
            <input 
              type="date" 
              [(ngModel)]="editAppointmentData.date" 
              name="editDate"
              class="form-input"
              required>
          </div>

          <div class="form-group">
            <label class="form-label">Hora *</label>
            <input 
              type="time" 
              [(ngModel)]="editAppointmentData.time" 
              name="editTime"
              class="form-input"
              required>
          </div>
        </div>

        <!-- CAMPOS NO EDITABLES -->
        <div class="form-group">
          <label class="form-label">Título</label>
          <div class="readonly-field">
            {{ editingAppointment?.title }}
            <span class="readonly-badge">No editable</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Duración</label>
          <div class="readonly-field">
            60 minutos
            <span class="readonly-badge">Estándar</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Motivo</label>
          <div class="readonly-field">
            {{ getMotivoDisplay(editingAppointment!) }}
            <span class="readonly-badge">No editable</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Modalidad</label>
          <div class="readonly-field">
            {{ getModalidadDisplay(editingAppointment!) }}
            <span class="readonly-badge">No editable</span>
          </div>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeEditModal()">Cancelar</button>
        <button 
          type="submit" 
          class="btn-primary" 
          [disabled]="isEditing">
          {{ isEditing ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
      </div>
    </form>
  </div>
</div>