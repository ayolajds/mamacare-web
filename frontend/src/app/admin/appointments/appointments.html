<div class="appointments-management">
  <!-- Header -->
  <div class="management-header">
    <div class="header-content">
      <h1 class="management-title">Gestión de Sesiones</h1>
      <p class="management-subtitle">Administra citas y calendario de profesionales</p>
    </div>
    <div class="header-actions">
      <button class="btn-primary" (click)="openCreateModal()">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Nueva Cita
      </button>
      <button class="btn-refresh" (click)="loadAppointments()" [disabled]="isLoading">
        <svg class="refresh-icon" [class.loading]="isLoading" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        {{ isLoading ? 'Actualizando...' : 'Actualizar' }}
      </button>
    </div>
  </div>

  <!-- Filtros y Búsqueda -->
  <div class="filters-section">
    <div class="filters-main">
      <div class="search-box">
        <div class="search-input-wrapper">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input 
            type="text" 
            [(ngModel)]="searchTerm" 
            (input)="onSearch()"
            placeholder="Buscar por título, paciente o profesional..." 
            class="search-input"
          >
        </div>
      </div>

      <div class="filter-row">
        <select [(ngModel)]="statusFilter" (change)="onFilterChange()" class="filter-select">
          <option value="">Todos los estados</option>
          <option value="scheduled">Programada</option>
          <option value="confirmed">Confirmada</option>
          <option value="in_progress">En progreso</option>
          <option value="completed">Completada</option>
          <option value="cancelled">Cancelada</option>
        </select>

        <select [(ngModel)]="typeFilter" (change)="onFilterChange()" class="filter-select">
          <option value="">Todos los tipos</option>
          <option value="consultation">Consulta</option>
          <option value="follow_up">Seguimiento</option>
          <option value="emergency">Emergencia</option>
          <option value="therapy">Terapia</option>
        </select>

        <input 
          type="date" 
          [(ngModel)]="dateFilter"
          (change)="onFilterChange()"
          class="filter-select"
        >

        <button (click)="clearFilters()" class="btn-clear-filters">
          <svg class="clear-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- Estados de carga y error -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="loading-spinner"></div>
    <p>Cargando sesiones...</p>
  </div>

  <div *ngIf="error && !isLoading" class="error-state">
    <div class="error-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </div>
    <h3>Error al cargar las sesiones</h3>
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="loadAppointments()">Reintentar</button>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!isLoading && !error" class="appointments-container">
    <!-- Resumen -->
    <div class="summary-bar">
      <span class="summary-text">
        Mostrando {{ filteredAppointments.length }} de {{ pagination.totalItems }} sesiones
        <span *ngIf="searchTerm || statusFilter || typeFilter" class="filtered-indicator">
          (filtradas)
        </span>
      </span>
    </div>

    <!-- Tarjetas de sesiones -->
    <div class="appointments-grid">
      <div *ngFor="let appointment of filteredAppointments" class="appointment-card" [class]="getStatusClass(appointment.status)">
        <div class="card-header">
          <h3 class="appointment-title">{{ appointment.title }}</h3>
          <div class="status-badge" [class]="getStatusBadgeClass(appointment.status)">
            {{ getStatusDisplay(appointment.status) }}
          </div>
        </div>

        <div class="card-content">
          <div class="info-row">
            <div class="info-item">
              <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <div class="info-content">
                <span class="info-label">Fecha y Hora</span>
                <span class="info-value">{{ formatDateTime(appointment.date) }}</span>
                <span class="info-duration">{{ appointment.duration }} min</span>
              </div>
            </div>

            <div class="info-item">
              <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <div class="info-content">
                <span class="info-label">Paciente</span>
                <span class="info-value">
                  {{ getPatientName(appointment) }} {{ getPatientLastName(appointment) }}
                </span>
                <span class="info-email">{{ getPatientEmail(appointment) }}</span>
              </div>
            </div>

            <div class="info-item">
              <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <div class="info-content">
                <span class="info-label">Profesional</span>
                <span class="info-value">
                  {{ getProfessionalName(appointment) }} {{ getProfessionalLastName(appointment) }}
                </span>
                <span class="info-email">{{ getProfessionalEmail(appointment) }}</span>
              </div>
            </div>

            <div class="info-item">
              <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
              </svg>
              <div class="info-content">
                <span class="info-label">Tipo</span>
                <span class="info-value">{{ getTypeDisplay(appointment.type) }}</span>
                <span class="info-platform">{{ getPlatformDisplay(appointment.meetingPlatform) }}</span>
              </div>
            </div>
          </div>

          <div *ngIf="appointment.reason" class="reason-section">
            <span class="reason-label">Motivo:</span>
            <p class="reason-text">{{ appointment.reason }}</p>
          </div>
        </div>

        <div class="card-actions">
          <!-- Botones para citas PROGRAMADAS/CONFIRMADAS -->
          <button 
            *ngIf="appointment.status === 'scheduled' || appointment.status === 'confirmed'"
            (click)="cancelAppointment(appointment)"
            [disabled]="isUpdating[appointment._id]"
            class="btn-cancel"
          >
            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            {{ isUpdating[appointment._id] ? 'Cancelando...' : 'Cancelar' }}
          </button>

          <!-- Botón EDITAR solo para citas NO canceladas -->
          <button 
            *ngIf="appointment.status !== 'cancelled'"
            (click)="editAppointment(appointment)"
            class="btn-edit"
          >
            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Editar
          </button>

          <!-- Botón REAGENDAR solo para citas CANCELADAS -->
          <button 
            *ngIf="appointment.status === 'cancelled'"
            (click)="openRescheduleModal(appointment)"
            class="btn-reschedule"
          >
            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Reagendar
          </button>

          <button 
            *ngIf="appointment.status === 'scheduled'"
            (click)="confirmAppointment(appointment)"
            [disabled]="isUpdating[appointment._id]"
            class="btn-confirm"
          >
            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            {{ isUpdating[appointment._id] ? 'Confirmando...' : 'Confirmar' }}
          </button>
        </div>
      </div>

      <!-- Estado vacío -->
      <div *ngIf="filteredAppointments.length === 0" class="empty-state">
        <div class="empty-content">
          <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <h3>No se encontraron sesiones</h3>
          <p *ngIf="searchTerm || statusFilter || typeFilter">
            Intenta ajustar los filtros de búsqueda
          </p>
          <p *ngIf="!searchTerm && !statusFilter && !typeFilter">
            No hay sesiones programadas en el sistema
          </p>
          <button *ngIf="searchTerm || statusFilter || typeFilter" 
                  (click)="clearFilters()" 
                  class="btn-clear-filters">
            Limpiar filtros
          </button>
          <button *ngIf="!searchTerm && !statusFilter && !typeFilter" 
                  (click)="openCreateModal()" 
                  class="btn-primary">
            Crear primera sesión
          </button>
        </div>
      </div>
    </div>

    <!-- Paginación -->
    <div *ngIf="pagination.totalPages > 1" class="pagination-container">
      <div class="pagination-info">
        Página {{ pagination.currentPage }} de {{ pagination.totalPages }}
      </div>
      
      <div class="pagination-controls">
        <button 
          (click)="prevPage()" 
          [disabled]="!pagination.hasPrev"
          class="pagination-btn"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Anterior
        </button>

        <div class="page-numbers">
          <button 
            *ngFor="let page of getPageNumbers()" 
            (click)="goToPage(page)"
            [class.active]="page === pagination.currentPage"
            class="page-btn"
            [disabled]="page === -1"
          >
            {{ getPageButtonText(page) }}
          </button>
        </div>

        <button 
          (click)="nextPage()" 
          [disabled]="!pagination.hasNext"
          class="pagination-btn"
        >
          Siguiente
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de creación de cita -->
<div *ngIf="showCreateModal" class="modal-overlay" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Crear Nueva Cita</h2>
      <button class="modal-close" (click)="closeCreateModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <form (ngSubmit)="createAppointment()" #appointmentForm="ngForm">
      <div class="modal-body">
        
        <!-- Profesional -->
        <div class="form-group">
          <label class="form-label">Profesional *</label>
          <select 
            [(ngModel)]="newAppointment.professionalId" 
            name="professionalId" 
            class="form-select"
            required
            #professionalSelect="ngModel">
            <option value="">Seleccionar profesional</option>
            <option *ngFor="let user of professionals" [value]="user._id">
              {{ user.name }} {{ user.lastName }} - {{ user.email }}
            </option>
          </select>
          <div *ngIf="professionalSelect.invalid && professionalSelect.touched" class="error-message">
            Selecciona un profesional
          </div>
        </div>

        <!-- Paciente -->
        <div class="form-group">
          <label class="form-label">Paciente *</label>
          <select 
            [(ngModel)]="newAppointment.patientId" 
            name="patientId" 
            class="form-select"
            required
            #patientSelect="ngModel">
            <option value="">Seleccionar paciente</option>
            <option *ngFor="let user of patients" [value]="user._id">
              {{ user.name }} {{ user.lastName }} - {{ user.email }}
            </option>
          </select>
          <div *ngIf="patientSelect.invalid && patientSelect.touched" class="error-message">
            Selecciona un paciente
          </div>
        </div>

        <!-- Título -->
        <div class="form-group">
          <label class="form-label">Título *</label>
          <input 
            type="text" 
            [(ngModel)]="newAppointment.title" 
            name="title"
            class="form-input"
            placeholder="Ej: Consulta de seguimiento, Entrega de kit..."
            required
            #titleInput="ngModel">
          <div *ngIf="titleInput.invalid && titleInput.touched" class="error-message">
            El título es requerido
          </div>
        </div>

        <!-- Fecha y Hora -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Fecha *</label>
            <input 
              type="date" 
              [(ngModel)]="newAppointment.date" 
              name="date"
              class="form-input"
              required
              #dateInput="ngModel">
            <div *ngIf="dateInput.invalid && dateInput.touched" class="error-message">
              La fecha es requerida
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Hora *</label>
            <input 
              type="time" 
              [(ngModel)]="newAppointment.time" 
              name="time"
              class="form-input"
              required
              #timeInput="ngModel">
            <div *ngIf="timeInput.invalid && timeInput.touched" class="error-message">
              La hora es requerida
            </div>
          </div>
        </div>

        <!-- Duración -->
        <div class="form-group">
          <label class="form-label">Duración (minutos) *</label>
          <select 
            [(ngModel)]="newAppointment.duration" 
            name="duration"
            class="form-select"
            required
            #durationSelect="ngModel">
            <option value="30">30 minutos</option>
            <option value="45">45 minutos</option>
            <option value="60" selected>60 minutos</option>
            <option value="90">90 minutos</option>
            <option value="120">120 minutos</option>
          </select>
        </div>

        <!-- Tipo -->
        <div class="form-group">
          <label class="form-label">Tipo de cita *</label>
          <select 
            [(ngModel)]="newAppointment.type" 
            name="type"
            class="form-select"
            required
            #typeSelect="ngModel">
            <option value="consultation">Consulta médica</option>
            <option value="therapy">Acompañamiento psicológico</option>
            <option value="follow_up">Seguimiento</option>
            <option value="emergency">Emergencia</option>
            <option value="evaluation">Evaluación</option>
          </select>
        </div>

        <!-- Motivo -->
        <div class="form-group">
          <label class="form-label">Motivo</label>
          <textarea 
            [(ngModel)]="newAppointment.reason" 
            name="reason"
            class="form-textarea"
            placeholder="Descripción del motivo de la cita..."
            rows="3"></textarea>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeCreateModal()">Cancelar</button>
        <button 
          type="submit" 
          class="btn-primary" 
          [disabled]="isCreating || !appointmentForm.form.valid">
          {{ isCreating ? 'Creando...' : 'Crear Cita' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de edición de cita -->
<div *ngIf="showEditModal" class="modal-overlay" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Editar Cita</h2>
      <button class="modal-close" (click)="closeEditModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <form (ngSubmit)="updateAppointment()">
      <div class="modal-body">
        
        <!-- Profesional -->
        <div class="form-group">
          <label class="form-label">Profesional *</label>
          <select 
            [(ngModel)]="editAppointmentData.professionalId" 
            name="editProfessionalId" 
            class="form-select"
            required>
            <option value="">Seleccionar profesional</option>
            <option *ngFor="let user of professionals" [value]="user._id">
              {{ user.name }} {{ user.lastName }} - {{ user.email }}
            </option>
          </select>
        </div>

        <!-- Paciente -->
        <div class="form-group">
          <label class="form-label">Paciente *</label>
          <select 
            [(ngModel)]="editAppointmentData.patientId" 
            name="editPatientId" 
            class="form-select"
            required>
            <option value="">Seleccionar paciente</option>
            <option *ngFor="let user of patients" [value]="user._id">
              {{ user.name }} {{ user.lastName }} - {{ user.email }}
            </option>
          </select>
        </div>

        <!-- Título -->
        <div class="form-group">
          <label class="form-label">Título *</label>
          <input 
            type="text" 
            [(ngModel)]="editAppointmentData.title" 
            name="editTitle"
            class="form-input"
            placeholder="Ej: Consulta de seguimiento, Entrega de kit..."
            required>
        </div>

        <!-- Fecha y Hora -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Fecha *</label>
            <input 
              type="date" 
              [(ngModel)]="editAppointmentData.date" 
              name="editDate"
              class="form-input"
              required>
          </div>

          <div class="form-group">
            <label class="form-label">Hora *</label>
            <input 
              type="time" 
              [(ngModel)]="editAppointmentData.time" 
              name="editTime"
              class="form-input"
              required>
          </div>
        </div>

        <!-- Duración -->
        <div class="form-group">
          <label class="form-label">Duración (minutos) *</label>
          <select 
            [(ngModel)]="editAppointmentData.duration" 
            name="editDuration"
            class="form-select"
            required>
            <option value="30">30 minutos</option>
            <option value="45">45 minutos</option>
            <option value="60">60 minutos</option>
            <option value="90">90 minutos</option>
            <option value="120">120 minutos</option>
          </select>
        </div>

        <!-- Tipo -->
        <div class="form-group">
          <label class="form-label">Tipo de cita *</label>
          <select 
            [(ngModel)]="editAppointmentData.type" 
            name="editType"
            class="form-select"
            required>
            <option value="consultation">Consulta médica</option>
            <option value="therapy">Acompañamiento psicológico</option>
            <option value="follow_up">Seguimiento</option>
            <option value="emergency">Emergencia</option>
            <option value="evaluation">Evaluación</option>
          </select>
        </div>

        <!-- Motivo -->
        <div class="form-group">
          <label class="form-label">Motivo</label>
          <textarea 
            [(ngModel)]="editAppointmentData.reason" 
            name="editReason"
            class="form-textarea"
            placeholder="Descripción del motivo de la cita..."
            rows="3"></textarea>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeEditModal()">Cancelar</button>
        <button 
          type="submit" 
          class="btn-primary" 
          [disabled]="isEditing">
          {{ isEditing ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- NUEVO: Modal de reagendar cita cancelada -->
<div *ngIf="showRescheduleModal" class="modal-overlay" (click)="closeRescheduleModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Reagendar Cita Cancelada</h2>
      <button class="modal-close" (click)="closeRescheduleModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <form (ngSubmit)="rescheduleAppointment()">
      <div class="modal-body">
        
        <!-- Información de solo lectura -->
        <div class="readonly-info" *ngIf="reschedulingAppointment">
          <div class="info-item">
            <strong>Paciente:</strong> 
            {{ getPatientName(reschedulingAppointment) }} {{ getPatientLastName(reschedulingAppointment) }}
          </div>
          <div class="info-item">
            <strong>Profesional:</strong> 
            {{ getProfessionalName(reschedulingAppointment) }} {{ getProfessionalLastName(reschedulingAppointment) }}
          </div>
          <div class="info-item">
            <strong>Motivo original:</strong> 
            {{ reschedulingAppointment.reason || 'Sin motivo especificado' }}
          </div>
        </div>

        <!-- Fecha y Hora -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nueva Fecha *</label>
            <input 
              type="date" 
              [(ngModel)]="rescheduleData.date" 
              name="rescheduleDate"
              class="form-input"
              required
              [min]="getTodayDate()">
          </div>

          <div class="form-group">
            <label class="form-label">Nueva Hora *</label>
            <input 
              type="time" 
              [(ngModel)]="rescheduleData.time" 
              name="rescheduleTime"
              class="form-input"
              required>
          </div>
        </div>

        <!-- Duración -->
        <div class="form-group">
          <label class="form-label">Duración (minutos) *</label>
          <select 
            [(ngModel)]="rescheduleData.duration" 
            name="rescheduleDuration"
            class="form-select"
            required>
            <option value="30">30 minutos</option>
            <option value="45">45 minutos</option>
            <option value="60">60 minutos</option>
            <option value="90">90 minutos</option>
            <option value="120">120 minutos</option>
          </select>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeRescheduleModal()">Cancelar</button>
        <button 
          type="submit" 
          class="btn-primary" 
          [disabled]="isRescheduling">
          {{ isRescheduling ? 'Reagendando...' : 'Reagendar Cita' }}
        </button>
      </div>
    </form>
  </div>
</div>