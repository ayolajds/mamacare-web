<!-- solicitudes-pendientes.component.html -->
<div class="solicitudes-container">
  <!-- Header con bot√≥n de volver -->
  <div class="header">
    <div class="header-top">
      <button class="btn-back" (click)="volverAtras()">
        <i class="fas fa-arrow-left"></i>
        Volver Atr√°s
      </button>
    </div>
    <h1><i class="fas fa-clock"></i> Solicitudes de Cita Pendientes</h1>
    <p class="subtitle"><i class="fas fa-tasks"></i> Gestiona las solicitudes de citas enviadas por pacientes</p>
  </div>

  <!-- Filtros Mejorados -->
  <div class="filtros-section">
    <div class="filtros-header">
      <i class="fas fa-filter"></i>
      <h2>Filtros y B√∫squeda</h2>
    </div>

    <div class="filtros-grid">
      <!-- B√∫squeda -->
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          placeholder="Buscar paciente por nombre..." 
          (input)="onSearch()"
          class="search-input"
        >
        <span class="search-hint">Enter para buscar</span>
      </div>

      <!-- üî• QUITADO: Filtro por tipo de cita -->

      <!-- Estad√≠sticas -->
      <div class="stats-card">
        <i class="fas fa-file-alt stats-icon"></i>
        <div class="stats-number">{{ solicitudesFiltradas.length }}</div>
        <div class="stats-label">Solicitudes</div>
      </div>
    </div>

    <!-- Filtros activos -->
    @if (searchTerm) {
      <div class="filtros-activos">
        @if (searchTerm) {
          <div class="filtro-activo">
            <i class="fas fa-search"></i>
            B√∫squeda: "{{ searchTerm }}"
            <button class="remove-filtro" (click)="searchTerm = ''; onSearch()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        }
      </div>
    }
  </div>

  <!-- Estados de carga -->
  @if (cargandoSolicitudes) {
    <div class="loading-state">
      <i class="fas fa-spinner fa-spin"></i>
      <h3>Cargando solicitudes...</h3>
      <p>Por favor espere mientras se cargan las solicitudes pendientes</p>
    </div>
  }

  <!-- Lista de solicitudes -->
  @if (!cargandoSolicitudes) {
    <div class="solicitudes-grid">
      <!-- Tarjeta de solicitud -->
      @for (solicitud of solicitudesFiltradas; track solicitud._id) {
        <div class="solicitud-card">
          <div class="card-header">
            <div class="paciente-info">
              <h3 class="paciente-nombre">
                <i class="fas fa-user-injured"></i>
                {{ getPacienteNombre(solicitud) }}
              </h3>
              <div class="paciente-meta">
                <div class="meta-item">
                  <i class="fas fa-calendar"></i>
                  <strong>Solicitado:</strong> {{ formatFecha(solicitud.createdAt) }}
                </div>
                <div class="meta-item">
                  <i class="fas fa-map-marker-alt"></i>
                  <strong>Modalidad:</strong> {{ getModalidadDisplay(solicitud.solicitud?.tipoPreferido) }}
                </div>
                <!-- üî• CORREGIDO: Mostrar nombre del paquete -->
                <div class="meta-item" *ngIf="solicitud.paqueteId">
                  <i class="fas fa-box"></i>
                  <strong>Paquete:</strong> {{ getNombrePaquete(solicitud.paqueteId) }}
                </div>
                <div class="meta-item" *ngIf="!solicitud.paqueteId">
                  <i class="fas fa-box"></i>
                  <strong>Paquete:</strong> Sin paquete
                </div>
              </div>
            </div>
            <!-- üî• QUITADO: Badge de tipo de cita -->
          </div>

          <div class="card-content">
            <div class="descripcion">
              <strong><i class="fas fa-comment-medical"></i> Motivo:</strong><br>
              {{ solicitud.solicitud?.motivo || 'No especificado' }}
            </div>

            @if (solicitud.solicitud?.sintomas && solicitud.solicitud.sintomas.length > 0) {
              <div class="sintomas-section">
                <div class="sintomas-title">
                  <i class="fas fa-notes-medical"></i>
                  <strong>S√≠ntomas reportados:</strong>
                </div>
                <div class="sintomas-tags">
                  @for (sintoma of solicitud.solicitud.sintomas; track sintoma) {
                    <span class="sintoma-tag">
                      {{ sintoma }}
                    </span>
                  }
                </div>
              </div>
            }
          </div>

          <div class="card-footer">
            <button class="btn btn-success" (click)="abrirModalAprobar(solicitud)">
              <i class="fas fa-check-circle"></i>
              Aprobar y Asignar
            </button>
            <button class="btn btn-danger" (click)="abrirModalRechazar(solicitud)">
              <i class="fas fa-times-circle"></i>
              Rechazar
            </button>
          </div>
        </div>
      }

      <!-- Estado vac√≠o -->
      @if (solicitudesFiltradas.length === 0 && !cargandoSolicitudes) {
        <div class="empty-state">
          <i class="fas fa-inbox"></i>
          <h3>No hay solicitudes pendientes</h3>
          <p>Todas las solicitudes han sido procesadas o no hay nuevas solicitudes.</p>
          <button class="btn btn-primary" (click)="cargarSolicitudes()">
            <i class="fas fa-refresh"></i>
            Recargar
          </button>
        </div>
      }
    </div>
  }
</div>

<!-- Modal para aprobar solicitud -->
@if (showAprobarModal) {
  <div class="modal-overlay">
    <div class="modal-content large-modal">
      <div class="modal-header">
        <h2><i class="fas fa-check-circle"></i> Aprobar Solicitud de Cita</h2>
        <button class="close-btn" (click)="cerrarModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- ‚úÖ NUEVA SECCI√ìN: Informaci√≥n completa de la solicitud -->
      <div class="solicitud-info" *ngIf="solicitudSeleccionada">
        <h4><i class="fas fa-info-circle"></i> Informaci√≥n de la Solicitud</h4>
        
        <div class="info-grid">
          <div class="info-item">
            <strong>Tipo solicitado:</strong>
            <span [class]="(solicitudSeleccionada.solicitud?.tipoPreferido || 'presencial') === 'virtual' ? 'virtual-badge' : 'presencial-badge'">
              {{ getModalidadDisplay(solicitudSeleccionada.solicitud?.tipoPreferido || 'presencial') }}
            </span>
          </div>
          
          <div class="info-item" *ngIf="solicitudSeleccionada.paqueteId">
            <strong>Paquete:</strong>
            <span>{{ getNombrePaquete(solicitudSeleccionada.paqueteId) }}</span>
          </div>
          
          <div class="info-item" *ngIf="solicitudSeleccionada.solicitud?.motivo">
            <strong>Motivo:</strong>
            <span>{{ solicitudSeleccionada.solicitud?.motivo }}</span>
          </div>
          
          <div class="info-item" *ngIf="solicitudSeleccionada.solicitud?.sintomas">
            <strong>S√≠ntomas:</strong>
<span>
  {{ getSintomasDisplay(solicitudSeleccionada.solicitud?.sintomas) }}
</span>
          </div>
        </div>
      </div>

      <form [formGroup]="asignacionForm" class="asignacion-form">
        <h4><i class="fas fa-calendar-plus"></i> Asignar Cita</h4>
        
        <!-- Profesional -->
        <div class="form-group">
          <label>
            <i class="fas fa-user-md"></i>
            Profesional *
          </label>
          <select formControlName="professionalId" class="form-select">
            <option value="">Seleccionar profesional</option>
            @if (cargandoProfesionales) {
              <option value="" disabled>Cargando profesionales...</option>
            } @else {
              @for (prof of profesionales; track prof._id) {
                <option [value]="prof._id">
                  {{ getNombreProfesional(prof) }} - {{ getEspecialidadProfesional(prof) }}
                </option>
              }
            }
          </select>
          @if (asignacionForm.get('professionalId')?.invalid && asignacionForm.get('professionalId')?.touched) {
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              Selecciona un profesional
            </div>
          }
          @if (profesionales.length === 0 && !cargandoProfesionales) {
            <div class="warning-message">
              <i class="fas fa-exclamation-triangle"></i>
              No hay profesionales disponibles. Contacte al administrador.
            </div>
          }
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>
              <i class="fas fa-calendar-day"></i>
              Fecha *
            </label>
            <input 
              type="date" 
              formControlName="fecha" 
              [min]="fechaMinima" 
              class="form-input"
            >
            @if (asignacionForm.get('fecha')?.invalid && asignacionForm.get('fecha')?.touched) {
              <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                Fecha requerida
              </div>
            }
          </div>
          <div class="form-group">
            <label>
              <i class="fas fa-clock"></i>
              Hora *
            </label>
            <input 
              type="time" 
              formControlName="hora" 
              class="form-input"
            >
            @if (asignacionForm.get('hora')?.invalid && asignacionForm.get('hora')?.touched) {
              <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                Hora requerida
              </div>
            }
          </div>
        </div>

        <!-- ‚úÖ CORREGIDO: Duraci√≥n fija de 60 minutos -->
        <div class="form-group">
          <label>
            <i class="fas fa-hourglass-half"></i>
            Duraci√≥n de la Sesi√≥n
          </label>
          <div class="duration-info">
            <div class="duration-badge">
              <i class="fas fa-clock"></i>
              60 minutos
            </div>
            <div class="form-hint">
              Duraci√≥n est√°ndar para todas las sesiones terap√©uticas
            </div>
          </div>
        </div>

        <!-- Notas adicionales -->
        <div class="form-group">
          <label>
            <i class="fas fa-sticky-note"></i>
            Notas para el profesional (Opcional)
          </label>
          <textarea 
            formControlName="notas" 
            placeholder="Agregue notas espec√≠ficas para el profesional sobre esta cita..."
            rows="3"
            class="form-textarea"
          ></textarea>
          <div class="form-hint">
            Esta informaci√≥n ser√° visible solo para el profesional asignado
          </div>
        </div>

        <div class="modal-info">
          <i class="fas fa-info-circle"></i>
          <p>Al confirmar, se crear√° una cita formal y se notificar√° al paciente por correo electr√≥nico.</p>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
            <i class="fas fa-times"></i>
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn btn-success" 
            (click)="aprobarSolicitud()" 
            [disabled]="asignacionForm.invalid || profesionales.length === 0"
          >
            <i class="fas fa-check-circle"></i>
            Confirmar Cita
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Modal para rechazar -->
@if (showRechazarModal) {
  <div class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-times-circle"></i> Rechazar Solicitud</h2>
        <button class="close-btn" (click)="cerrarModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="solicitud-preview">
        <div class="preview-item">
          <i class="fas fa-user"></i>
          <strong>Paciente:</strong> {{ getPacienteNombre(solicitudSeleccionada) }}
        </div>
        <!-- üî• QUITADO: Tipo de cita del modal de rechazo -->
        <div class="warning-message">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Esta acci√≥n no se puede deshacer.</strong> El paciente recibir√° una notificaci√≥n del rechazo.
        </div>
      </div>

      <div class="form-group">
        <label>
          <i class="fas fa-comment-exclamation"></i>
          Motivo del rechazo *
        </label>
        <textarea 
          [(ngModel)]="motivoRechazo" 
          placeholder="Explica el motivo del rechazo para que el paciente pueda entender la decisi√≥n. Sea claro y profesional en su explicaci√≥n..."
          rows="4"
          class="form-textarea"
        ></textarea>
        <div class="char-count" [class.warning]="motivoRechazo.length > 190">
          {{ motivoRechazo.length }}/200 caracteres
        </div>
        <div class="form-hint">
          M√≠nimo 10 caracteres. Este mensaje ser√° enviado al paciente.
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
          <i class="fas fa-arrow-left"></i>
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-danger" 
          (click)="rechazarSolicitud()"
          [disabled]="!motivoRechazo.trim() || motivoRechazo.trim().length < 10"
        >
          <i class="fas fa-ban"></i>
          Rechazar Solicitud
        </button>
      </div>
    </div>
  </div>
}