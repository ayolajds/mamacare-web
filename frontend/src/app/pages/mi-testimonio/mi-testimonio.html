<div class="t-container">
  <!-- HERO -->
  <section class="hero">
    <div class="wrap">
      <button class="btn back" type="button" (click)="volverAHistorias()">
        <i class="icon-arrow-left"></i> Volver a Historias
      </button>

      <h1 class="title">Comparte tu Historia</h1>
      <p class="subtitle">
        <i class="icon-sparkle"></i>
        Tu experiencia puede ser el faro que guíe a otras mujeres en su camino.
      </p>
    </div>
  </section>

  <!-- CONTENT -->
  <section class="content">
    <div class="wrap">

      <!-- Cargando permisos -->
      <div *ngIf="verificandoPermisos" class="panel center">
        <div class="spinner"></div>
        <p>Verificando permisos…</p>
      </div>

      <!-- Sin permiso -->
      <div *ngIf="!verificandoPermisos && !puedeDarTestimonio" class="panel center">
        <div class="bubble"><i class="icon-crown"></i></div>
        <h2>Próximamente podrás compartir</h2>
        <p>Esta función está disponible para quienes han adquirido paquetes de Ma'Care.</p>
        <div class="actions">
          <button class="btn ghost" (click)="volverAHistorias()">
            <i class="icon-book-open"></i> Ver historias
          </button>
          <button class="btn primary" (click)="verPaquetes()">
            <i class="icon-gift"></i> Ver paquetes
          </button>
        </div>
      </div>

      <!-- Formulario -->
      <div *ngIf="!verificandoPermisos && puedeDarTestimonio" class="panel">
        <header class="head">
          <h2>Cuéntanos tu experiencia</h2>
          <p><i class="icon-edit"></i>Completa los campos para compartir tu historia con la comunidad.</p>
        </header>

        <form [formGroup]="testimonioForm" (ngSubmit)="enviarTestimonio()" novalidate>
          
          <!-- CORTO -->
          <div class="group">
            <label class="label"
                   [class.near]="textoCortoLength > 180"
                   [class.over]="textoCortoLength > 200">
              <span><i class="icon-message-circle"></i> Testimonio breve *</span>
              <span class="count">{{ textoCortoLength }}/200</span>
            </label>
            <textarea class="control"
                      id="textoCorto"
                      rows="3"
                      placeholder="Escribe 1–2 frases que resuman tu experiencia…"
                      formControlName="textoCorto"></textarea>
            <small *ngIf="textoCorto?.touched && textoCorto?.invalid" class="error">
              <i class="icon-alert-circle"></i>
              <ng-container *ngIf="textoCorto?.errors?.['required']">Este campo es requerido.</ng-container>
              <ng-container *ngIf="textoCorto?.errors?.['minlength']">Mínimo 10 caracteres.</ng-container>
              <ng-container *ngIf="textoCorto?.errors?.['maxlength']">Máximo 200 caracteres.</ng-container>
            </small>
          </div>

          <!-- HISTORIA -->
          <div class="group">
            <label class="label"
                   [class.near]="historiaLength > 1800"
                   [class.over]="historiaLength > 2000">
              <span><i class="icon-book"></i> Tu historia completa</span>
              <span class="count">{{ historiaLength }}/2000</span>
            </label>
            <textarea class="control"
                      rows="6"
                      placeholder="Comparte más detalles de tu proceso, desafíos y aprendizajes…"
                      formControlName="historiaCompleta"></textarea>
          </div>

          <!-- IMPACTO -->
          <div class="group">
            <label class="label"
                   [class.near]="impactoLength > 450"
                   [class.over]="impactoLength > 500">
              <span><i class="icon-trending-up"></i> El impacto en tu vida</span>
              <span class="count">{{ impactoLength }}/500</span>
            </label>
            <textarea class="control"
                      rows="3"
                      placeholder="¿Qué cambios notaste? ¿Qué te ayudó más?"
                      formControlName="impacto"></textarea>
          </div>

          <!-- CIUDAD -->
          <div class="group">
            <label class="label">
              <span><i class="icon-map-pin"></i> Tu ciudad</span>
            </label>
            <input class="control" 
                   type="text" 
                   placeholder="¿Desde qué ciudad nos escribes?"
                   formControlName="ciudad">
          </div>

          <!-- IMAGEN -->
          <div class="group">
            <label class="label">
              <span><i class="icon-image"></i> Imagen (opcional)</span>
            </label>

            <div class="uploader"
                 [class.dragging]="dragging"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (drop)="onDrop($event)">
              
              <input type="file" 
                     accept="image/jpeg,image/png,image/webp"
                     (change)="onFileChange($event)" 
                     hidden #fileInput>
              
              <button type="button" class="btn ghost" (click)="fileInput.click()">
                <i class="icon-upload"></i> Seleccionar imagen
              </button>
              
              <p class="hint">JPG/PNG/WEBP — máx. {{ MAX_FILE_MB }} MB</p>

              <div *ngIf="previewUrl" class="preview">
                <img [src]="previewUrl" alt="Previsualización de imagen">
                <button type="button" class="btn tiny danger" (click)="clearImage()">
                  <i class="icon-x"></i> Quitar
                </button>
              </div>
            </div>

            <small *ngIf="imagenError" class="error">
              <i class="icon-alert-triangle"></i> {{ imagenError }}
            </small>
          </div>

          <!-- TAGS -->
          <div class="group">
            <label class="label">
              <span><i class="icon-tag"></i> ¿Qué aspectos destacarías?</span>
            </label>
            <div class="tags">
              <button type="button"
                      class="tag"
                      *ngFor="let tag of tagsDisponibles"
                      [class.on]="testimonioForm.get('tags')?.value?.includes(tag)"
                      (click)="toggleTag(tag)">
                <i class="icon-check" *ngIf="testimonioForm.get('tags')?.value?.includes(tag)"></i>
                {{ tag }}
              </button>
            </div>
          </div>

          <!-- ACCIONES -->
          <div class="actions end">
            <button type="button" class="btn ghost" (click)="volverAHistorias()">
              <i class="icon-x"></i> Cancelar
            </button>
            <button type="submit" 
                    class="btn primary" 
                    [disabled]="enviando || testimonioForm.invalid">
              <ng-container *ngIf="!enviando">
                <i class="icon-send"></i> Enviar mi historia
              </ng-container>
              <ng-container *ngIf="enviando">
                <i class="icon-loader spin"></i> Enviando…
              </ng-container>
            </button>
          </div>
        </form>
      </div>

    </div>
  </section>
</div>