<div class="pago-container">
  <div class="container">
    <!-- Header -->
    <div class="pago-header">
      <button class="btn-back" (click)="cancelar()">
        <i data-lucide="arrow-left"></i>
        Volver a Kits
      </button>
      <h1>Proceso de Pago</h1>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Cargando información del kit...</p>
    </div>

    <!-- Content -->
    <div class="pago-content" *ngIf="!isLoading && kit">
      <div class="pago-grid">
        <!-- Resumen del Kit -->
        <div class="resumen-kit">
          <h2>
            <i data-lucide="package"></i>
            Resumen de tu Compra
          </h2>
          <div class="kit-card">
            <div class="kit-header">
              <h3 class="kit-nombre">{{ kit.nombre }}</h3>
              <div class="kit-precio">
                ${{ formatPrice(kit.precio) }} COP
                <span *ngIf="tieneDescuento" class="precio-original">
                  ${{ formatPrice(kit.precioOriginal!) }} COP
                </span>
              </div>
            </div>
            
            <p class="kit-descripcion">{{ kit.descripcion }}</p>

            <div class="kit-detalles">
              <div class="detalle-item">
                <i data-lucide="star"></i>
                <span>Kit {{ kit.categoria | titlecase }}</span>
              </div>
              <div class="detalle-item">
                <i data-lucide="check-circle"></i>
                <span>Entrega inmediata después del pago</span>
              </div>
              <div class="detalle-item">
                <i data-lucide="shield-check"></i>
                <span>Garantía de calidad</span>
              </div>
            </div>

            <div class="elementos-incluidos">
              <h4>
                <i data-lucide="list-check"></i>
                Este kit incluye:
              </h4>
              <ul>
                <li *ngFor="let elemento of kit.elementos">
                  <i data-lucide="check"></i>
                  {{ elemento }}
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Formulario de Pago -->
        <div class="formulario-pago">
          <h2>
            <i data-lucide="credit-card"></i>
            Información de Pago
          </h2>
          
          <div class="pago-card">
            <!-- Selección de Banco -->
            <div class="form-group">
              <label for="banco">
                <i data-lucide="building"></i>
                Método de Pago *
              </label>
              <select 
                id="banco" 
                [(ngModel)]="bancoSeleccionado" 
                (change)="onBancoSeleccionado()"
                class="form-select"
                [disabled]="isProcessing">
                <option value="">Selecciona tu banco o método de pago</option>
                <option *ngFor="let banco of bancos" [value]="banco.value">
                  {{ banco.icon }} {{ banco.label }}
                </option>
              </select>
            </div>

            <!-- Información Personal -->
            <div class="form-section">
              <h3>
                <i data-lucide="user"></i>
                Información Personal
              </h3>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="tipoDocumento">Tipo de Documento *</label>
                  <select 
                    id="tipoDocumento" 
                    [(ngModel)]="tipoDocumento"
                    class="form-select"
                    [disabled]="isProcessing">
                    <option value="">Selecciona tipo de documento</option>
                    <option *ngFor="let tipo of tiposDocumento" [value]="tipo.value">
                      {{ tipo.label }}
                    </option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="numeroDocumento">Número de Documento *</label>
                  <input 
                    type="text" 
                    id="numeroDocumento"
                    [(ngModel)]="numeroDocumento"
                    (input)="onNumeroDocumentoInput($event)"
                    placeholder="Ingresa tu número de documento"
                    maxlength="20"
                    [disabled]="isProcessing"
                    class="form-input">
                  <small class="input-hint">Solo números</small>
                </div>
              </div>

              <div class="form-group">
                <label for="nombreTitular">
                  <i data-lucide="user-check"></i>
                  Nombre del Titular *
                </label>
                <input 
                  type="text" 
                  id="nombreTitular"
                  [(ngModel)]="nombreTitular"
                  (input)="onNombreTitularInput($event)"
                  placeholder="Nombre completo como aparece en el documento"
                  maxlength="100"
                  [disabled]="isProcessing"
                  class="form-input">
                <small class="input-hint">Solo letras y espacios</small>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="email">
                    <i data-lucide="mail"></i>
                    Email *
                  </label>
                  <input 
                    type="email" 
                    id="email"
                    [(ngModel)]="email"
                    (input)="onEmailInput($event)"
                    placeholder="tu@email.com"
                    maxlength="100"
                    [disabled]="isProcessing"
                    class="form-input">
                </div>
                
                <div class="form-group">
                  <label for="telefono">
                    <i data-lucide="phone"></i>
                    Teléfono *
                  </label>
                  <input 
                    type="tel" 
                    id="telefono"
                    [(ngModel)]="telefono"
                    (input)="onTelefonoInput($event)"
                    placeholder="3001234567"
                    maxlength="15"
                    [disabled]="isProcessing"
                    class="form-input">
                  <small class="input-hint">Solo números (10-15 dígitos)</small>
                </div>
              </div>
            </div>

            <!-- Información de Tarjeta (solo si no es PSE) -->
            <div class="form-section" *ngIf="bancoSeleccionado && bancoSeleccionado !== 'pse'">
              <h3>
                <i data-lucide="credit-card"></i>
                Información de Tarjeta
              </h3>
              
              <div class="form-group">
                <label for="numeroTarjeta">Número de Tarjeta *</label>
                <input 
                  type="text" 
                  id="numeroTarjeta"
                  [(ngModel)]="numeroTarjeta"
                  (input)="onNumeroTarjetaInput($event)"
                  placeholder="1234 5678 9012 3456"
                  maxlength="19"
                  [disabled]="isProcessing"
                  class="form-input">
                <small class="input-hint">Solo números (16 dígitos)</small>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="fechaExpiracion">Fecha de Expiración *</label>
                  <input 
                    type="text" 
                    id="fechaExpiracion"
                    [(ngModel)]="fechaExpiracion"
                    (input)="onFechaExpiracionInput($event)"
                    placeholder="MM/AA"
                    maxlength="5"
                    [disabled]="isProcessing"
                    class="form-input">
                  <small class="input-hint">Formato MM/AA</small>
                </div>
                
                <div class="form-group">
                  <label for="cvv">CVV *</label>
                  <input 
                    type="text" 
                    id="cvv"
                    [(ngModel)]="cvv"
                    (input)="onCvvInput($event)"
                    placeholder="123"
                    maxlength="4"
                    [disabled]="isProcessing"
                    class="form-input">
                  <small class="input-hint">Solo números (3-4 dígitos)</small>
                </div>
              </div>
            </div>

            <!-- Mensaje informativo para PSE -->
            <div class="info-message" *ngIf="bancoSeleccionado === 'pse'">
              <i data-lucide="info"></i>
              <p>Serás redirigido a la plataforma segura de tu banco para completar el pago.</p>
            </div>

            <!-- Resumen de Pago -->
            <div class="info-pago">
              <div class="info-item">
                <span>Subtotal:</span>
                <span>${{ formatPrice(kit.precio) }} COP</span>
              </div>
              
              <div *ngIf="tieneDescuento" class="info-item descuento">
                <span>Descuento ({{ kit.descuento }}%):</span>
                <span>- ${{ formatPrice(calcularAhorro()) }} COP</span>
              </div>
              
              <div class="info-item">
                <span>IVA (0%):</span>
                <span>$0 COP</span>
              </div>
              
              <div class="info-item total">
                <span>Total a pagar:</span>
                <span>${{ formatPrice(kit.precio) }} COP</span>
              </div>
            </div>

            <!-- Términos y Condiciones -->
            <div class="terminos-condiciones">
              <label class="checkbox-label">
                <input 
                  type="checkbox" 
                  [(ngModel)]="aceptaTerminos"
                  [disabled]="isProcessing"
                  class="checkbox-input">
                <span class="checkmark"></span>
                Acepto los 
                <a href="javascript:void(0)" (click)="mostrarTerminos()" class="link">términos y condiciones</a> 
                y la 
                <a href="/privacidad" target="_blank" class="link">política de privacidad</a>
              </label>
            </div>

            <!-- Botón de Pago -->
            <button 
              class="btn-pagar" 
              (click)="procesarPago()"
              [disabled]="!validarFormularioCompleto() || isProcessing"
              [class.loading]="isProcessing">
              
              <span *ngIf="!isProcessing">
                <i data-lucide="shield-check"></i>
                <span *ngIf="bancoSeleccionado === 'pse'">Proceder con PSE</span>
                <span *ngIf="bancoSeleccionado !== 'pse'">Pagar ${{ formatPrice(kit.precio) }} COP</span>
              </span>
              <span *ngIf="isProcessing">
                <div class="spinner-small"></div>
                Procesando pago...
              </span>
            </button>

            <div class="pago-seguro">
              <i data-lucide="shield"></i>
              <span>Pago 100% seguro y encriptado · Tus datos están protegidos</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error state -->
    <div class="error-state" *ngIf="!isLoading && !kit">
      <div class="error-icon">
        <i data-lucide="alert-circle"></i>
      </div>
      <h3>Kit no encontrado</h3>
      <p>El kit que buscas no está disponible</p>
      <button class="btn-primary" (click)="cancelar()">
        <i data-lucide="arrow-left"></i>
        Volver a Kits
      </button>
    </div>
  </div>
</div>